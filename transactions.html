<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Daily Money Log</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --bg1:#F7F8FC; --bg2:#EEF2F7;
  --card:#FFFFFF; --border:#E5E7EB;
  --text:#374151; --muted:#6B7280;
  --accent:#9AA7D8;
  --radius:14px;
}

body::before {
  content:"";
  position:fixed; inset:0;
  background:
    radial-gradient(circle at 15% 20%, #9AA7D8 0, transparent 35%),
    radial-gradient(circle at 85% 80%, #7FB7A3 0, transparent 40%);
  opacity:.035; pointer-events:none;
}

* { box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }

body {
  margin:0;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  color:var(--text);
  min-height:100vh;
  padding:80px 16px 40px;
}

.clock {
  position:fixed; top:16px; right:20px;
  font-size:13px; color:var(--muted);
}

.container {
  max-width:1100px;
  margin:auto;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:24px;
  animation:fadeUp .4s ease;
}

h1 { grid-column:span 2; margin:0; }

.card {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:24px;
}

label { font-size:13px; font-weight:500; margin-bottom:6px; display:block; }
.field { margin-bottom:18px; }

input,select,button {
  width:100%; padding:10px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:14px;
}

input[readonly] { background:#F3F4F6; }

button {
  border:none;
  background:var(--accent);
  color:#fff;
  font-weight:600;
}

button:disabled { opacity:.6; cursor:not-allowed; }

.hidden { display:none; }

table { width:100%; border-collapse:collapse; font-size:13px; }
thead th {
  text-align:left;
  padding:8px;
  border-bottom:1px solid var(--border);
  color:var(--muted);
}
tbody td {
  padding:8px;
  border-bottom:1px dashed #E5E7EB;
}
td.amount { text-align:right; font-weight:600; }
td.accounts { color:var(--muted); font-size:12px; }

@media(max-width:900px){
  .container { grid-template-columns:1fr; }
  h1 { grid-column:span 1; }
}

@keyframes fadeUp {
  from { opacity:0; transform:translateY(8px); }
  to { opacity:1; transform:none; }
}
</style>
</head>

<body>

<div class="clock" id="clock"></div>

<div class="container">
<h1>Daily Money Log</h1>

<!-- FORM -->
<div class="card">
<form id="txnForm">

<div class="field">
<label>Date</label>
<input type="date" id="txnDate" required>
</div>

<div class="field">
<label>Type</label>
<select id="txnType" required>
<option value="">Select</option>
<option value="INCOME">Income</option>
<option value="EXP">Expense</option>
<option value="EMI">EMI Payment</option>
<option value="SAVINGS">Savings</option>
<option value="TRANSFER">Transfer</option>
</select>
</div>

<div class="field">
<label>Category</label>
<select id="category"></select>
</div>

<div class="field hidden" id="subBlock">
<label>Sub Category</label>
<select id="subCategory"></select>
</div>

<div class="field">
<label>Amount</label>
<input type="number" id="amount" required>
</div>

<div class="field hidden" id="emiBlock">
<label>EMI</label>
<select id="emiId"></select>
</div>

<div class="field hidden" id="fromBlock">
<label>From Account</label>
<select id="fromAccount"></select>
</div>

<div class="field hidden" id="toBlock">
<label>To Account</label>
<select id="toAccount"></select>
</div>

<div class="field">
<label>Notes (Optional)</label>
<input type="text" id="notes" placeholder="Any additional details">
</div>

<button id="saveBtn" type="submit">Save Transaction</button>
</form>
</div>

<!-- LAST 10 -->
<div class="card">
<h3>Last 10 Transactions</h3>
<div id="recentTxns">Loading…</div>
</div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzFrvs7pVyW7HCciqHeNF_1oQVCScJkH_6gem3YXt5lVyxjfJXh36wOXYIRYIho4gGz/exec";

const txnForm=document.getElementById("txnForm");
const txnType=txnForm.txnType;
const category=txnForm.category;
const subCategory=txnForm.subCategory;
const amount=txnForm.amount;
const emiId=txnForm.emiId;
const fromAccount=txnForm.fromAccount;
const toAccount=txnForm.toAccount;
const notes=document.getElementById("notes");
const saveBtn=document.getElementById("saveBtn");

let allAccounts=[], subMap={}, emiMap={};

setInterval(()=>clock.textContent=new Date().toLocaleString("en-IN",{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}),1000);

async function init(){
  allAccounts = await fetch(API+"?action=accounts").then(r=>r.json());
  subMap = await fetch(API+"?action=subcategories").then(r=>r.json());

  const emis = await fetch(API+"?action=emis").then(r=>r.json());
  emiId.innerHTML="<option value=''>Select EMI</option>";
  emis.forEach(e=>{ emiMap[e.id]=e.amount; emiId.innerHTML+=`<option value="${e.id}">${e.name}</option>`; });

  rebuildFrom();
  loadRecent();
}
init();

function rebuildFrom(){
  fromAccount.innerHTML="<option value=''>Select</option>"+allAccounts.map(a=>`<option>${a}</option>`).join("");
}
function rebuildTo(exclude=""){
  toAccount.innerHTML="<option value=''>Select</option>"+allAccounts.filter(a=>a!==exclude).map(a=>`<option>${a}</option>`).join("");
}

/* TYPE RULES — FIXED SAVINGS */
txnType.onchange=()=>{
  fromBlock.classList.add("hidden");
  toBlock.classList.add("hidden");
  emiBlock.classList.add("hidden");
  subBlock.classList.add("hidden");
  amount.readOnly=false;
  category.innerHTML="";

  if(txnType.value==="INCOME"){
    category.innerHTML="<option>Income</option>";
    toBlock.classList.remove("hidden");
    rebuildTo();
  }

  if(txnType.value==="EXP"){
    ["Living Essentials","Transport & Mobility","Lifestyle & Personal","Health & Wellness"]
      .forEach(c=>category.innerHTML+=`<option>${c}</option>`);
    fromBlock.classList.remove("hidden");
    subBlock.classList.remove("hidden");
  }

  if(txnType.value==="SAVINGS"){
    category.innerHTML="<option>Savings</option>";
    fromBlock.classList.remove("hidden");   // ✅ FIX
  }

  if(txnType.value==="EMI"){
    category.innerHTML="<option>Financial Commitments</option>";
    emiBlock.classList.remove("hidden");
    fromBlock.classList.remove("hidden");
  }

  if(txnType.value==="TRANSFER"){
    category.innerHTML="<option>Transfer</option>";
    fromBlock.classList.remove("hidden");
    toBlock.classList.remove("hidden");
    rebuildFrom();
    rebuildTo();
  }
};

category.onchange=()=>{
  subCategory.innerHTML=(subMap[category.value]||[]).map(s=>`<option>${s}</option>`).join("");
};

emiId.onchange=()=>{
  amount.value=emiMap[emiId.value]||"";
  amount.readOnly=!!emiMap[emiId.value];
};

fromAccount.onchange=()=>{
  if(txnType.value==="TRANSFER") rebuildTo(fromAccount.value);
};

txnForm.onsubmit=async e=>{
  e.preventDefault();
  saveBtn.disabled=true;
  saveBtn.textContent="Saving…";

  await fetch(API,{method:"POST",body:JSON.stringify({
    action:"addTransaction",
    payload:{
      txnDate:txnDate.value,
      txnType:txnType.value,
      category:category.value,
      subCategory:subCategory.value,
      amount:Number(amount.value),
      fromAccount:fromAccount.value,
      toAccount:toAccount.value,
      emiId:emiId.value,
      notes:notes.value,
      source:"WEB"
    }
  })});

  txnForm.reset();
  saveBtn.disabled=false;
  saveBtn.textContent="Save Transaction";
  loadRecent();
};

async function loadRecent(){
  const box=document.getElementById("recentTxns");
  try{
    const data=await fetch(API+"?action=recent").then(r=>r.json());
    box.innerHTML=`
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Type</th><th>Category</th><th>Accounts</th><th style="text-align:right">Amount</th>
          </tr>
        </thead>
        <tbody>
        ${data.map(t=>`
          <tr>
            <td>${t.date}</td>
            <td>${t.type}</td>
            <td>${t.category}</td>
            <td class="accounts">${t.from||""}${t.to?` → ${t.to}`:""}</td>
            <td class="amount">₹ ${t.amount}</td>
          </tr>`).join("")}
        </tbody>
      </table>`;
  }catch{
    box.innerHTML="<em>No recent transactions</em>";
  }
}
</script>

</body>
</html>
