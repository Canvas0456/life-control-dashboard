<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Transaction</title>

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --primary:#007aff;
  --danger:#ff3b30;
  --text:#1c1c1e;
  --muted:#6e6e73;
  --radius:18px;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI";}
body{margin:0;background:var(--bg);padding:20px;}
.container{max-width:620px;margin:auto;}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:22px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
}
h1{margin:0 0 6px;font-size:22px;}
.sub{font-size:13px;color:var(--muted);margin-bottom:16px;}
label{display:block;margin-top:14px;font-size:13px;color:var(--muted);}
input,select,textarea{
  width:100%;padding:12px;margin-top:6px;
  border-radius:12px;border:1px solid #ddd;font-size:14px;
}
textarea{resize:none}
button{
  width:100%;margin-top:22px;padding:14px;
  border:none;border-radius:14px;
  background:var(--primary);color:#fff;font-size:15px;
}
.error{color:var(--danger);font-size:12px;margin-top:8px}
.success{color:#2ecc71;text-align:center;margin-top:12px}
.hidden{display:none}

/* ===== Last 10 Table ===== */
.toggle{
  margin-top:22px;
  font-size:14px;
  color:var(--primary);
  cursor:pointer;
  user-select:none;
}
.table-wrap{
  margin-top:14px;
  display:none;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #eee;
  text-align:left;
}
th{color:var(--muted);font-weight:600}
.badge{
  padding:2px 8px;
  border-radius:10px;
  background:#eef3ff;
  font-size:11px;
}
</style>
</head>

<body>
<div class="container">
<div class="card">
<h1>Add Transaction</h1>
<div class="sub">Fast • Clean • Controlled</div>

<label>Date</label>
<input type="date" id="date">

<label>Transaction Type</label>
<select id="txnType">
  <option value="">Select</option>
  <option>Income</option>
  <option>Expense</option>
  <option>Transfer</option>
</select>

<label>Level</label>
<select id="level"></select>

<label>Category</label>
<select id="category"></select>

<label>Sub-Category</label>
<select id="subCategory"></select>

<label>Amount (₹)</label>
<input type="number" id="amount">

<label>From Account</label>
<select id="fromAccount"></select>

<div id="toBlock" class="hidden">
  <label>To Account</label>
  <select id="toAccount"></select>
</div>

<label>Notes</label>
<textarea id="notes" rows="2"></textarea>

<div class="error" id="error"></div>
<button id="saveBtn">Save Transaction</button>
<div class="success" id="success"></div>

<!-- ===== Last 10 Toggle ===== -->
<div class="toggle" id="toggleRecent">Show last 10 transactions ⌄</div>

<div class="table-wrap" id="recentWrap">
<table>
<thead>
<tr>
  <th>Date</th>
  <th>Type</th>
  <th>Category</th>
  <th>Amount</th>
  <th>From → To</th>
</tr>
</thead>
<tbody id="recentBody"></tbody>
</table>
</div>

</div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbx0qkMTieJu2dm1sfhd0zvJ8KgKCocfZHNIXyHw6adNjj5cTReMXGO2uKbB_do0PTPLMw/exec";
const $=id=>document.getElementById(id);
let master={};

$("date").valueAsDate=new Date();

/* ===== Load Dropdowns ===== */
fetch(API+"?mode=dropdowns")
.then(r=>r.json())
.then(d=>{
  master=d;
  loadAccounts();
  loadRecent();
});

function loadAccounts(){
  ["fromAccount","toAccount"].forEach(id=>{
    $(id).innerHTML="<option value=''>Select</option>"+
      master.accounts.map(a=>`<option>${a}</option>`).join("");
  });
}

/* ===== Dynamic Logic ===== */
$("txnType").onchange=()=>{
  reset();
  const t=$("txnType").value;
  if(!t)return;

  if(t==="Income"){
    $("level").innerHTML="<option>Income</option>";
    loadCategories("Income");
    $("toBlock").classList.remove("hidden");
  }
  if(t==="Expense"){
    loadLevels(["Variable","Savings","Sinking"]);
  }
  if(t==="Transfer"){
    $("level").innerHTML="<option>Transfer</option>";
    loadCategories("Transfer");
    $("toBlock").classList.remove("hidden");
  }
};

$("level").onchange=()=>loadCategories($("level").value);
$("category").onchange=()=>loadSub($("level").value,$("category").value);

function loadLevels(arr){
  $("level").innerHTML="<option value=''>Select</option>"+arr.map(v=>`<option>${v}</option>`).join("");
}
function loadCategories(l){
  $("category").innerHTML="<option value=''>Select</option>"+
    Object.keys(master.categories[l]||{}).map(c=>`<option>${c}</option>`).join("");
}
function loadSub(l,c){
  $("subCategory").innerHTML="<option value=''>Select</option>"+
    (master.categories[l][c]||[]).map(s=>`<option>${s}</option>`).join("");
}
function reset(){
  ["level","category","subCategory"].forEach(i=>$(i).innerHTML="");
  $("toBlock").classList.add("hidden");
}

/* ===== Save ===== */
$("saveBtn").onclick=async()=>{
  $("error").textContent="";$("success").textContent="";

  if(new Date($("date").value)<new Date("2026-02-01"))
    return $("error").textContent="January is locked. Start from Feb-2026.";

  if(!$("txnType").value||!$("level").value||!$("category").value||!$("subCategory").value)
    return $("error").textContent="Complete all category fields.";

  if(!$("amount").value||$("amount").value<=0)
    return $("error").textContent="Amount must be greater than zero.";

  if($("txnType").value==="Transfer" && $("fromAccount").value===$("toAccount").value)
    return $("error").textContent="From and To account cannot be same.";

  const payload={
    type:"transaction",
    date:$("date").value,
    txnType:$("txnType").value,
    level1:$("level").value,
    category:$("category").value,
    subCategory:$("subCategory").value,
    amount:$("amount").value,
    fromAccount:$("fromAccount").value,
    toAccount:$("toAccount").value,
    notes:$("notes").value
  };

  $("saveBtn").disabled=true;
  const r=await fetch(API,{method:"POST",body:JSON.stringify(payload)}).then(r=>r.json());
  $("saveBtn").disabled=false;

  if(r.status!=="success") return $("error").textContent=r.message;

  $("success").textContent="Transaction saved successfully";
  loadRecent();
};

/* ===== Recent Table ===== */
$("toggleRecent").onclick=()=>{
  const w=$("recentWrap");
  w.style.display=w.style.display==="none"?"block":"none";
};

function loadRecent(){
  fetch(API+"?mode=recent&type=transactions")
  .then(r=>r.json())
  .then(rows=>{
    $("recentBody").innerHTML=rows.map(r=>`
      <tr>
        <td>${r.date}</td>
        <td><span class="badge">${r.type}</span></td>
        <td>${r.category}<br><small>${r.sub}</small></td>
        <td>₹${r.amount}</td>
        <td>${r.from||"-"} → ${r.to||"-"}</td>
      </tr>
    `).join("");
  });
}
</script>
</body>
</html>
