<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daily Money Log</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0F172A;
  --card:#1E293B;
  --accent:#2DD4BF;
  --text:#F8FAFC;
  --glass:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:'Inter',sans-serif;
  padding:24px;
}
#clock{
  position:fixed;
  top:14px;
  right:22px;
  font-size:.8rem;
  opacity:.85;
}
.container{max-width:1200px;margin:auto}
.card{
  background:var(--glass);
  backdrop-filter:blur(14px);
  border:1px solid var(--border);
  border-radius:18px;
  padding:20px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:20px;
}
label{font-size:.72rem;opacity:.8;margin-top:14px;display:block}
input,select{
  width:100%;
  margin-top:6px;
  padding:10px 12px;
  border-radius:12px;
  border:none;
  background:#020617;
  color:var(--text);
}
.hidden{display:none}
.locked{opacity:.5;pointer-events:none}
button{
  margin-top:20px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:999px;
  background:var(--accent);
  color:#022c22;
  font-weight:600;
  letter-spacing:1px;
  cursor:pointer;
}
footer{
  text-align:center;
  margin-top:40px;
  font-size:.7rem;
  opacity:.6;
}
</style>
</head>

<body>

<div id="clock"></div>

<div class="container">
<h2>ðŸ’¸ Daily Money Log</h2>

<div class="grid">

<!-- FORM -->
<div class="card">
<label>Date</label>
<input type="date" id="txnDate">

<label>Type</label>
<select id="txnType">
  <option value="EXP">Expense</option>
  <option value="INC">Income</option>
  <option value="TRANSFER">Transfer</option>
  <option value="SAV">Savings</option>
  <option value="EMI">EMI</option>
</select>

<div id="catBlock">
<label>Category</label>
<select id="category"></select>

<label>Sub Category</label>
<select id="subCategory"></select>
</div>

<div id="emiBlock" class="hidden">
<label>EMI</label>
<select id="emiSelect"></select>
</div>

<label>Amount</label>
<input type="number" id="amount">

<div id="fromBlock">
<label>From Account</label>
<select id="fromAccount"></select>
</div>

<div id="toBlock">
<label>To Account</label>
<select id="toAccount"></select>
</div>

<label>Notes</label>
<input id="notes">

<button id="saveBtn">SAVE TRANSACTION</button>
</div>

<!-- RECENT -->
<div class="card">
<h4>Last 10 Transactions</h4>
<table style="width:100%;font-size:.8rem">
<thead>
<tr>
<th>Date</th><th>Type</th><th>Category</th><th>Accounts</th><th>Amount</th>
</tr>
</thead>
<tbody id="recent"></tbody>
</table>
</div>

</div>

<footer>
Â© Designed & Engineered by <b>Kaiwalya Muley</b>
</footer>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzFrvs7pVyW7HCciqHeNF_1oQVCScJkH_6gem3YXt5lVyxjfJXh36wOXYIRYIho4gGz/exec";

/* CLOCK */
setInterval(()=>{
  const d=new Date();
  clock.innerText =
    d.toLocaleDateString(undefined,{weekday:'long',day:'2-digit',month:'short',year:'numeric'})
    +" â€¢ "+d.toLocaleTimeString();
},1000);

/* SAFE INIT */
document.addEventListener("DOMContentLoaded", init);

async function init(){
  try{
    const [
      accounts,
      categories,
      subcats,
      emis,
      recent
    ] = await Promise.all([
      fetch(API+"?action=accounts").then(r=>r.json()),
      fetch(API+"?action=categories").then(r=>r.json()),
      fetch(API+"?action=subcategories").then(r=>r.json()),
      fetch(API+"?action=emis").then(r=>r.json()),
      fetch(API+"?action=recent").then(r=>r.json())
    ]);

    fillSelect(fromAccount, accounts);
    fillSelect(toAccount, accounts);
    fillSelect(category, categories);

    category.onchange = () => {
      const list = subcats[category.value] || [];
      fillSelect(subCategory, list);
    };

    emiSelect.innerHTML = "";
    emis.forEach(e=>{
      emiSelect.innerHTML +=
        `<option value="${e.id}" data-amt="${e.amount}">${e.name}</option>`;
    });

    renderRecent(recent);
    handleType();

    console.log("âœ… Transactions API Loaded");
  }
  catch(err){
    console.error("âŒ INIT ERROR", err);
    alert("Failed to load master data. Check API.");
  }
}

/* TYPE RULES */
txnType.onchange = handleType;
fromAccount.onchange = filterTransfer;

function handleType(){
  const t = txnType.value;
  catBlock.classList.add("hidden");
  emiBlock.classList.add("hidden");
  fromBlock.classList.add("hidden");
  toBlock.classList.add("hidden");
  amount.classList.remove("locked");

  if(t==="EXP"){catBlock.classList.remove("hidden");fromBlock.classList.remove("hidden")}
  if(t==="INC"){toBlock.classList.remove("hidden")}
  if(t==="SAV"){toBlock.classList.remove("hidden")}
  if(t==="TRANSFER"){fromBlock.classList.remove("hidden");toBlock.classList.remove("hidden");filterTransfer()}
  if(t==="EMI"){
    emiBlock.classList.remove("hidden");
    fromBlock.classList.remove("hidden");
    amount.classList.add("locked");
    amount.value = emiSelect.selectedOptions[0]?.dataset.amt || "";
  }
}

function filterTransfer(){
  [...toAccount.options].forEach(o=>{
    o.hidden = o.value === fromAccount.value;
  });
}

/* SAVE */
saveBtn.onclick = async ()=>{
  saveBtn.disabled = true;
  saveBtn.innerText = "SAVINGâ€¦";

  const payload = {
    txnDate: txnDate.value,
    txnType: txnType.value,
    category: category.value || "",
    subCategory: subCategory.value || "",
    amount: amount.value,
    fromAccount: fromAccount.value || "",
    toAccount: toAccount.value || "",
    emiId: emiSelect.value || "",
    notes: notes.value,
    source: "WEB"
  };

  await fetch(API,{
    method:"POST",
    body:JSON.stringify({action:"addTransaction",payload})
  });

  location.reload();
};

/* HELPERS */
function fillSelect(sel, arr){
  sel.innerHTML = "";
  arr.forEach(v=>{
    sel.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

function renderRecent(rows){
  recent.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.date}</td>
      <td>${r.type}</td>
      <td>${r.category||""}</td>
      <td>${r.from||""} â†’ ${r.to||""}</td>
      <td>â‚¹${r.amount}</td>
    </tr>
  `).join("");
}
</script>

</body>
</html>
