<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Transaction Entry</title>

<style>
:root {
  --bg: #f5f7fb;
  --card: #ffffff;
  --primary: #007aff;
  --danger: #ff3b30;
  --text: #1c1c1e;
  --muted: #6e6e73;
  --radius: 18px;
}

* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI"; }

body {
  background: var(--bg);
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 520px;
  margin: auto;
}

.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 22px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.08);
  animation: fadeIn 0.4s ease;
}

h1 {
  margin: 0 0 6px;
  font-size: 22px;
}

.sub {
  color: var(--muted);
  font-size: 13px;
  margin-bottom: 16px;
}

label {
  display: block;
  margin-top: 14px;
  font-size: 13px;
  color: var(--muted);
}

input, select, textarea {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
  border-radius: 12px;
  border: 1px solid #ddd;
  font-size: 14px;
}

textarea { resize: none; }

.hidden { display: none; }

button {
  width: 100%;
  margin-top: 22px;
  padding: 14px;
  border: none;
  border-radius: 14px;
  background: var(--primary);
  color: white;
  font-size: 15px;
  cursor: pointer;
}

button:disabled {
  opacity: 0.6;
}

.error {
  color: var(--danger);
  font-size: 12px;
  margin-top: 6px;
}

.success {
  text-align: center;
  color: green;
  margin-top: 14px;
  font-size: 14px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <h1>Add Transaction</h1>
    <div class="sub">Clean • Structured • AI-Ready</div>

    <label>Transaction Date</label>
    <input type="date" id="date"/>

    <label>Transaction Type</label>
    <select id="txnType">
      <option value="">Select</option>
      <option>Income</option>
      <option>Expense</option>
      <option>Transfer</option>
    </select>

    <div id="levelBlock">
      <label>Level</label>
      <select id="level"></select>
    </div>

    <div id="catBlock">
      <label>Category</label>
      <select id="category"></select>
    </div>

    <div id="subBlock">
      <label>Sub-Category</label>
      <select id="subCategory"></select>
    </div>

    <label>Amount (₹)</label>
    <input type="number" id="amount"/>

    <div id="fromBlock">
      <label>From Account</label>
      <select id="fromAccount"></select>
    </div>

    <div id="toBlock" class="hidden">
      <label>To Account</label>
      <select id="toAccount"></select>
    </div>

    <label>Notes</label>
    <textarea id="notes" rows="2"></textarea>

    <div class="error" id="error"></div>

    <button id="saveBtn">Save Transaction</button>
    <div class="success" id="success"></div>
  </div>
</div>

<script>
const API = "YOUR_APPS_SCRIPT_EXEC_URL";

const el = id => document.getElementById(id);
const error = el("error");
const success = el("success");

let master = {};

fetch(API + "?mode=dropdowns")
.then(r => r.json())
.then(d => {
  master = d;
  loadAccounts();
});

function loadAccounts() {
  ["fromAccount","toAccount"].forEach(id=>{
    el(id).innerHTML = `<option value="">Select</option>` +
      master.accounts.map(a=>`<option>${a}</option>`).join("");
  });
}

el("txnType").onchange = () => {
  resetDynamic();
  const t = el("txnType").value;

  if (!t) return;

  if (t === "Income") {
    el("level").innerHTML = `<option>Income</option>`;
    loadCategories("Income");
    el("toBlock").classList.remove("hidden");
  }

  if (t === "Expense") {
    loadLevels(["Variable","Savings","Sinking"]);
    el("fromBlock").classList.remove("hidden");
  }

  if (t === "Transfer") {
    el("level").innerHTML = `<option>Transfer</option>`;
    loadCategories("Transfer");
    el("fromBlock").classList.remove("hidden");
    el("toBlock").classList.remove("hidden");
  }
};

el("level").onchange = () => loadCategories(el("level").value);
el("category").onchange = () => loadSub(el("level").value, el("category").value);

function loadLevels(arr){
  el("level").innerHTML = `<option value="">Select</option>` +
    arr.map(v=>`<option>${v}</option>`).join("");
}

function loadCategories(l){
  const cats = master.categories[l] || {};
  el("category").innerHTML = `<option value="">Select</option>` +
    Object.keys(cats).map(c=>`<option>${c}</option>`).join("");
}

function loadSub(l,c){
  const subs = master.categories[l][c] || [];
  el("subCategory").innerHTML = `<option value="">Select</option>` +
    subs.map(s=>`<option>${s}</option>`).join("");
}

function resetDynamic(){
  ["level","category","subCategory"].forEach(id=>el(id).innerHTML="");
  el("fromBlock").classList.add("hidden");
  el("toBlock").classList.add("hidden");
}

el("saveBtn").onclick = async () => {
  error.textContent = "";
  success.textContent = "";

  if (!el("date").value || new Date(el("date").value) < new Date("2026-02-01"))
    return error.textContent = "Date must be Feb-2026 or later";

  if (!el("txnType").value || !el("level").value || !el("category").value || !el("subCategory").value)
    return error.textContent = "Please complete all category fields";

  if (!el("amount").value || el("amount").value <= 0)
    return error.textContent = "Amount must be greater than zero";

  const payload = {
    type: "transaction",
    date: el("date").value,
    txnType: el("txnType").value,
    level1: el("level").value,
    category: el("category").value,
    subCategory: el("subCategory").value,
    amount: el("amount").value,
    fromAccount: el("fromAccount").value,
    toAccount: el("toAccount").value,
    notes: el("notes").value
  };

  el("saveBtn").disabled = true;

  const res = await fetch(API, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const r = await res.json();
  el("saveBtn").disabled = false;

  if (r.status !== "success")
    return error.textContent = r.message;

  success.textContent = "Transaction saved successfully";
  document.querySelector("form")?.reset();
};
</script>
</body>
</html>
