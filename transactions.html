<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Daily Money Log</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --bg1:#F7F8FC; --bg2:#EEF2F7;
  --card:#FFFFFF; --border:#E5E7EB;
  --text:#374151;
  --accent:#9AA7D8;
  --radius:14px;
}

/* BACKGROUND STICKERS */
body::before,
body::after {
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background-repeat:no-repeat;
  opacity:0.035;
}

body::before {
  background-image:
    radial-gradient(circle at 10% 20%, #9AA7D8 0, transparent 35%),
    radial-gradient(circle at 90% 80%, #7FB7A3 0, transparent 40%);
}

body::after {
  background-image:
    linear-gradient(120deg, transparent 75%, #E6A4A8 76%, transparent 80%);
}

* { box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }

body {
  margin:0;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  color:var(--text);
  min-height:100vh;
  padding:80px 16px 40px;
}

.clock {
  position:fixed;
  top:16px; right:20px;
  font-size:13px; color:#6B7280;
}

.container {
  max-width:1100px;
  margin:auto;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:24px;
  animation:fadeUp .4s ease;
}

h1 { grid-column:span 2; margin:0; }

.card {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:24px;
}

label { font-size:13px; font-weight:500; margin-bottom:6px; display:block; }
.field { margin-bottom:18px; }

input,select,button {
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:14px;
}

input[readonly] { background:#F3F4F6; }

button {
  border:none;
  background:var(--accent);
  color:#fff;
  font-weight:600;
}

button:disabled {
  opacity:0.6;
}

.hidden { display:none; }

.txn {
  display:flex;
  justify-content:space-between;
  font-size:13px;
  padding:8px 0;
  border-bottom:1px dashed #E5E7EB;
}

@media(max-width:900px){
  .container { grid-template-columns:1fr; }
  h1 { grid-column:span 1; }
}

@keyframes fadeUp {
  from { opacity:0; transform:translateY(8px); }
  to { opacity:1; transform:none; }
}
</style>
</head>

<body>

<div class="clock" id="clock"></div>

<div class="container">
<h1>Daily Money Log</h1>

<!-- FORM -->
<div class="card">
<form id="txnForm">

<div class="field">
<label>Date</label>
<input type="date" id="txnDate" required>
</div>

<div class="field">
<label>Type</label>
<select id="txnType" required>
<option value="">Select</option>
<option value="INCOME">Income</option>
<option value="EXP">Expense</option>
<option value="EMI">EMI Payment</option>
<option value="SAVINGS">Savings</option>
<option value="TRANSFER">Transfer</option>
</select>
</div>

<div class="field">
<label>Category</label>
<select id="category"></select>
</div>

<div class="field hidden" id="subBlock">
<label>Sub Category</label>
<select id="subCategory"></select>
</div>

<div class="field">
<label>Amount</label>
<input type="number" id="amount" required>
</div>

<div class="field hidden" id="emiBlock">
<label>EMI</label>
<select id="emiId"></select>
</div>

<div class="field hidden" id="fromBlock">
<label>From Account</label>
<select id="fromAccount"></select>
</div>

<div class="field hidden" id="toBlock">
<label>To Account</label>
<select id="toAccount"></select>
</div>

<button id="saveBtn" type="submit">Save Transaction</button>
</form>
</div>

<!-- LAST 10 -->
<div class="card">
<h3>Last 10 Transactions</h3>
<div id="recentTxns">Loading…</div>
</div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzFrvs7pVyW7HCciqHeNF_1oQVCScJkH_6gem3YXt5lVyxjfJXh36wOXYIRYIho4gGz/exec";

const txnType=txnForm.txnType;
const category=txnForm.category;
const subCategory=txnForm.subCategory;
const amount=txnForm.amount;
const emiId=txnForm.emiId;
const fromAccount=txnForm.fromAccount;
const toAccount=txnForm.toAccount;
const saveBtn=document.getElementById("saveBtn");

let allAccounts=[], allCategories=[], subMap={}, emiMap={};

setInterval(()=>clock.textContent=new Date().toLocaleString("en-IN",{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}),1000);

/* LOAD MASTERS */
async function init() {
  allAccounts = await fetch(API+"?action=accounts").then(r=>r.json());
  allCategories = await fetch(API+"?action=categories").then(r=>r.json());
  subMap = await fetch(API+"?action=subcategories").then(r=>r.json());

  const emis = await fetch(API+"?action=emis").then(r=>r.json());
  emis.forEach(e=>emiMap[e.id]=e.amount);
  emiId.innerHTML="<option value=''>Select EMI</option>"+emis.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");

  rebuildAccounts();
  loadRecent();
}

function rebuildAccounts(exclude="") {
  fromAccount.innerHTML="<option value=''>Select</option>"+allAccounts.map(a=>`<option>${a}</option>`).join("");
  toAccount.innerHTML="<option value=''>Select</option>"+allAccounts.filter(a=>a!==exclude).map(a=>`<option>${a}</option>`).join("");
}

/* TYPE LOGIC */
txnType.onchange=()=>{
  fromBlock.classList.add("hidden");
  toBlock.classList.add("hidden");
  emiBlock.classList.add("hidden");
  subBlock.classList.add("hidden");
  amount.readOnly=false;

  category.innerHTML="";
  if(txnType.value==="INCOME"){ category.innerHTML="<option>Income</option>"; }
  if(txnType.value==="EXP"){
    ["Living Essentials","Transport & Mobility","Lifestyle & Personal","Health & Wellness"]
    .forEach(c=>category.innerHTML+=`<option>${c}</option>`);
    subBlock.classList.remove("hidden");
    fromBlock.classList.remove("hidden");
  }
  if(txnType.value==="EMI"){
    category.innerHTML="<option>Financial Commitments</option>";
    emiBlock.classList.remove("hidden");
    fromBlock.classList.remove("hidden");
  }
  if(txnType.value==="TRANSFER"){
    category.innerHTML="<option>Transfer</option>";
    fromBlock.classList.remove("hidden");
    toBlock.classList.remove("hidden");
  }
};

category.onchange=()=>{
  subCategory.innerHTML=(subMap[category.value]||[]).map(s=>`<option>${s}</option>`).join("");
};

emiId.onchange=()=>{
  amount.value=emiMap[emiId.value]||"";
  amount.readOnly=!!emiMap[emiId.value];
};

fromAccount.onchange=()=>{
  if(txnType.value==="TRANSFER") rebuildAccounts(fromAccount.value);
};

/* SUBMIT — LOCK PAGE */
txnForm.onsubmit=async e=>{
  e.preventDefault();
  saveBtn.disabled=true;
  [...txnForm.elements].forEach(el=>el.disabled=true);

  await fetch(API,{method:"POST",body:JSON.stringify({
    action:"addTransaction",
    payload:{
      txnDate:txnDate.value,
      txnType:txnType.value,
      category:category.value,
      subCategory:subCategory.value,
      amount:Number(amount.value),
      fromAccount:fromAccount.value,
      toAccount:toAccount.value,
      emiId:emiId.value,
      source:"WEB"
    }
  })});

  location.reload();
};

/* RECENT */
async function loadRecent(){
  const r=document.getElementById("recentTxns");
  try{
    const data=await fetch(API+"?action=recent").then(r=>r.json());
    r.innerHTML=data.map(t=>`<div class="txn"><span>${t.date} • ${t.type}</span><span>₹ ${t.amount}</span></div>`).join("");
  }catch{
    r.innerHTML="<em>No recent data</em>";
  }
}

init();
</script>

</body>
</html>
