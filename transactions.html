<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Adding a Transaction</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#FDFCF9;
  --card:#FFFFFF;
  --accent:#3E5C45;
  --border:rgba(0,0,0,0.05);
  --text:#1F2937;
  --muted:#6B7280;
}

*{box-sizing:border-box;font-family:Inter,sans-serif}

body{
  margin:0;
  background:var(--bg);
  padding:24px 16px 80px;
}

.liveTime{
  position:fixed;
  top:14px;
  right:18px;
  font-size:13px;
  color:var(--muted);
}

.card{
  max-width:520px;
  margin:60px auto 0;
  background:var(--card);
  border-radius:32px;
  padding:32px;
  box-shadow:0 25px 60px rgba(0,0,0,.08);
}

h1{
  font-family:"Playfair Display",serif;
  margin:0 0 20px;
}

.amount{
  font-size:4rem;
  text-align:center;
  color:var(--accent);
  border:none;
  outline:none;
  width:100%;
  background:transparent;
}

label{
  font-size:13px;
  color:var(--muted);
  margin-top:18px;
  display:block;
}

input,select,textarea{
  width:100%;
  padding:14px;
  border-radius:18px;
  border:1px solid var(--border);
  margin-top:6px;
}

textarea{resize:none}

button{
  width:100%;
  margin-top:28px;
  padding:16px;
  border-radius:30px;
  border:none;
  background:var(--accent);
  color:#fff;
  font-size:16px;
  font-weight:600;
  transition:.3s;
}

button.success{background:#16A34A}
button.error{background:#DC2626}

.hidden{display:none}

details summary{
  cursor:pointer;
  font-weight:600;
  margin-top:28px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  margin-top:12px;
}
th,td{
  padding:8px;
  border-bottom:1px dashed #E5E7EB;
}
td:last-child{text-align:right}

.footer{
  text-align:center;
  margin-top:24px;
  font-size:12px;
  color:#9CA3AF;
}
</style>
</head>

<body>

<div class="liveTime" id="liveTime"></div>

<div class="card">
<h1>Adding a Transaction</h1>

<label>Date</label>
<input type="date" id="txnDate">

<input id="amount" class="amount" type="number" placeholder="0">

<label>Type</label>
<select id="type">
  <option value="">Select</option>
  <option value="INCOME">Income</option>
  <option value="EXP">Expense</option>
  <option value="SAVINGS">Savings</option>
  <option value="TRANSFER">Transfer</option>
  <option value="EMI">EMI</option>
</select>

<label>Category</label>
<select id="category"></select>

<div id="subWrap" class="hidden">
<label>Sub Category</label>
<select id="subCategory"></select>
</div>

<div id="emiWrap" class="hidden">
<label>EMI</label>
<select id="emiId"></select>
</div>

<div id="fromWrap" class="hidden">
<label>From Account</label>
<select id="fromAcc"></select>
</div>

<div id="toWrap" class="hidden">
<label>To Account</label>
<select id="toAcc"></select>
</div>

<label>Notes</label>
<textarea id="notes" rows="2" placeholder="What was this for?"></textarea>

<button id="saveBtn">Save Transaction</button>

<details>
<summary>Last 10 Transactions</summary>
<div id="recent"></div>
</details>

<div class="footer">
© Designed & Engineered by <strong>Kaiwalya Muley</strong>
</div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzFrvs7pVyW7HCciqHeNF_1oQVCScJkH_6gem3YXt5lVyxjfJXh36wOXYIRYIho4gGz/exec";

const type=document.getElementById("type");
const cat=document.getElementById("category");
const sub=document.getElementById("subCategory");
const amt=document.getElementById("amount");
const emi=document.getElementById("emiId");
const from=document.getElementById("fromAcc");
const to=document.getElementById("toAcc");
const saveBtn=document.getElementById("saveBtn");

const subWrap=document.getElementById("subWrap");
const emiWrap=document.getElementById("emiWrap");
const fromWrap=document.getElementById("fromWrap");
const toWrap=document.getElementById("toWrap");

let accounts=[], subMap={}, emiMap={};

document.getElementById("txnDate").value =
  new Date().toISOString().slice(0,10);

/* LIVE TIME */
setInterval(()=>{
  document.getElementById("liveTime").textContent =
    new Date().toLocaleString("en-IN",{
      weekday:"long",day:"2-digit",month:"short",
      year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"
    });
},1000);

(async()=>{
  accounts=await fetch(API+"?action=accounts").then(r=>r.json());
  subMap=await fetch(API+"?action=subcategories").then(r=>r.json());
  const emis=await fetch(API+"?action=emis").then(r=>r.json());

  from.innerHTML=to.innerHTML="<option></option>"+
    accounts.map(a=>`<option>${a}</option>`).join("");

  emi.innerHTML="<option></option>"+emis.map(e=>{
    emiMap[e.id]=e.amount;
    return `<option value="${e.id}">${e.name}</option>`;
  }).join("");

  loadRecent();
})();

type.onchange=()=>{
  cat.innerHTML="";
  subWrap.classList.add("hidden");
  emiWrap.classList.add("hidden");
  fromWrap.classList.add("hidden");
  toWrap.classList.add("hidden");
  amt.readOnly=false;

  if(type.value==="INCOME"){
    cat.innerHTML="<option>Income</option>";
    toWrap.classList.remove("hidden");
  }
  if(type.value==="EXP"){
    Object.keys(subMap).forEach(c=>cat.innerHTML+=`<option>${c}</option>`);
    fromWrap.classList.remove("hidden");
    subWrap.classList.remove("hidden");
  }
  if(type.value==="SAVINGS"){
    cat.innerHTML="<option>Savings</option>";
    fromWrap.classList.remove("hidden");
  }
  if(type.value==="TRANSFER"){
    cat.innerHTML="<option>Transfer</option>";
    fromWrap.classList.remove("hidden");
    toWrap.classList.remove("hidden");
  }
  if(type.value==="EMI"){
    cat.innerHTML="<option>Financial Commitments</option>";
    fromWrap.classList.remove("hidden");
    emiWrap.classList.remove("hidden");
  }
};

cat.onchange=()=>{
  sub.innerHTML=(subMap[cat.value]||[]).map(s=>`<option>${s}</option>`).join("");
};

from.onchange=()=>{
  if(type.value==="TRANSFER"){
    to.innerHTML="<option></option>"+
      accounts.filter(a=>a!==from.value)
      .map(a=>`<option>${a}</option>`).join("");
  }
};

emi.onchange=()=>{
  amt.value=emiMap[emi.value]||"";
  amt.readOnly=!!emiMap[emi.value];
};

saveBtn.onclick=async()=>{
  saveBtn.textContent="Saving…";
  saveBtn.className="";

  try{
    await fetch(API,{
      method:"POST",
      body:JSON.stringify({
        action:"addTransaction",
        payload:{
          txnDate:txnDate.value,
          txnType:type.value,
          category:cat.value,
          subCategory:sub.value,
          amount:Number(amt.value),
          fromAccount:from.value,
          toAccount:to.value,
          emiId:emi.value,
          notes:notes.value,
          source:"WEB"
        }
      })
    });

    saveBtn.textContent="Saved ✓";
    saveBtn.classList.add("success");
    setTimeout(()=>location.reload(),800);

  }catch{
    saveBtn.textContent="Error";
    saveBtn.classList.add("error");
  }
};

async function loadRecent(){
  const d=await fetch(API+"?action=recent").then(r=>r.json());
  document.getElementById("recent").innerHTML=`
  <table>
    <thead>
      <tr><th>Date</th><th>Type</th><th>Category</th><th>Accounts</th><th>₹</th></tr>
    </thead>
    <tbody>
    ${d.map(t=>`
      <tr>
        <td>${t.date}</td>
        <td>${t.type}</td>
        <td>${t.category}</td>
        <td>${t.from||""}${t.to?" → "+t.to:""}</td>
        <td>${t.amount}</td>
      </tr>`).join("")}
    </tbody>
  </table>`;
}
</script>

</body>
</html>
